import socket
import json
import keyboard
import time
HOST = "192.168.1.33"   # 改成顯示電腦的 IP，例如 "192.168.1.123"
PORT = 50008

TEST_LINES = """
35.55,-43.31,119.41,115.86,-88.3,184.33,0,0,0
35.55,-43.31,119.41,115.86,-88.3,184.33,0,0,0
35.55,-43.31,119.41,115.86,-88.3,184.33,0,0,0
35.27,-43.31,119.41,115.86,-88.3,184.33,0,0,0
34.22,-43.31,119.41,115.86,-88.3,184.33,0,0,0
32.55,-43.31,119.41,115.86,-88.3,184.33,0,0,0
30.45,-43.31,119.41,115.86,-88.3,184.33,0,0,0
27.34,-43.31,119.41,115.86,-88.3,184.33,0,0,0
25.15,-43.31,119.41,115.86,-88.3,184.33,0,0,0
22.53,-43.31,119.41,115.86,-88.3,184.33,0,0,0
19.88,-43.31,119.41,115.86,-88.3,184.33,0,0,0
17.68,-43.31,119.41,115.86,-88.3,184.33,0,0,0
14.16,-43.31,119.41,115.86,-88.3,184.33,0,0,0
11.52,-43.31,119.41,115.86,-88.3,184.33,0,0,0
8.87,-43.31,119.41,115.86,-88.3,184.33,0,0,0
6.25,-43.31,119.41,115.86,-88.3,184.33,0,0,0
3.6,-43.31,119.41,115.86,-88.3,184.33,0,0,0
1.41,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-1.24,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-3.43,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-6.5,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-9.15,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-11.35,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-13.99,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-16.19,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-18.84,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-21.03,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-23.68,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-25.88,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-28.95,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-31.14,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-33.79,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-36.44,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-38.63,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-41.28,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-43.48,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-45.67,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-47.87,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-50.94,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-52.71,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-55.78,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-58.43,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-60.63,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-63.27,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-65.89,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-68.54,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-71.19,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-73.38,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-76.03,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-78.68,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-81.3,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-83.94,-43.31,119.41,115.86,-88.3,184.33,0,0,0
-86.07,-43.25,119.43,115.78,-88.32,184.33,0,0,0
-87.83,-42.9,119.52,115.29,-88.45,184.31,0,0,0
-89.07,-41.75,119.82,113.68,-88.9,184.25,0,0,0
-89.52,-39.58,120.38,110.66,-89.73,184.14,0,0,0
-89.63,-38.24,120.72,108.81,-90.23,184.07,0,0,0
-89.82,-35.89,121.33,105.54,-91.13,183.95,0,0,0
-89.99,-33.87,121.85,102.72,-91.9,183.85,0,0,0
-90.15,-31.87,122.37,99.94,-92.67,183.75,0,0,0
-90.29,-30.19,122.8,97.6,-93.31,183.66,0,0,0
-90.46,-28.17,123.33,94.79,-94.08,183.56,0,0,0
-90.63,-26.15,123.85,91.97,-94.85,183.46,0,0,0
-90.8,-24.13,124.37,89.15,-95.63,183.36,0,0,0
-90.91,-22.79,124.72,87.3,-96.14,183.29,0,0,0
-91.11,-20.45,125.32,84.03,-97.03,183.17,0,0,0
-91.25,-18.75,125.76,81.67,-97.68,183.09,0,0,0
-91.45,-16.4,126.37,78.4,-98.58,182.97,0,0,0
-91.59,-14.72,126.81,76.07,-99.22,182.88,0,0,0
-91.73,-13.05,127.24,73.73,-99.86,182.8,0,0,0
-91.92,-10.68,127.85,70.43,-100.76,182.68,0,0,0
-92.09,-8.68,128.37,67.65,-101.53,182.58,0,0,0
-92.26,-6.65,128.89,64.83,-102.3,182.47,0,0,0
-92.4,-4.97,129.33,62.5,-102.94,182.39,0,0,0
-92.54,-3.27,129.77,60.13,-103.59,182.3,0,0,0
-92.74,-0.93,130.37,56.86,-104.49,182.18,0,0,0
-92.9,1.07,130.89,54.08,-105.25,182.08,0,0,0
-93.04,2.75,131.33,51.74,-105.89,182,0,0,0
-93.21,4.77,131.85,48.93,-106.67,181.89,0,0,0
-93.38,6.8,132.37,46.11,-107.44,181.79,0,0,0
-93.55,8.84,132.9,43.27,-108.22,181.69,0,0,0
-93.66,10.15,133.24,41.44,-108.72,181.62,0,0,0
-93.86,12.5,133.85,38.17,-109.62,181.5,0,0,0
-94,14.18,134.28,35.84,-110.26,181.42,0,0,0
-94.2,16.54,134.89,32.54,-111.16,181.3,0,0,0
-94.31,17.86,135.23,30.71,-111.67,181.23,0,0,0
-94.45,19.55,135.67,28.36,-112.31,181.15,0,0,0
-94.52,20.48,135.91,27.06,-112.67,181.1,0,0,0
-94.54,20.71,135.97,26.75,-112.75,181.09,0,0,0
-94.54,20.73,135.97,26.72,-112.76,181.09,0,0,0
-94.4,20.86,135.73,26.82,-112.62,181.1,0,0,0
-94.1,21.15,135.23,27.02,-112.33,181.12,0,0,0
-93.7,21.55,134.55,27.29,-111.92,181.15,0,0,0
-93.25,22,133.79,27.6,-111.47,181.18,0,0,0
-92.98,22.26,133.34,27.78,-111.2,181.2,0,0,0
-92.52,22.72,132.57,28.09,-110.74,181.23,0,0,0
-92.19,23.04,132.01,28.32,-110.41,181.25,0,0,0
-91.89,23.34,131.51,28.52,-110.11,181.27,0,0,0
-91.85,23.38,131.43,28.55,-110.07,181.27,0,0,0
-91.79,23.48,131.29,28.6,-110.01,181.28,0,0,0
-91.58,23.82,130.79,28.75,-109.8,181.29,0,0,0
-91.22,24.41,129.9,29.04,-109.44,181.32,0,0,0
-90.91,24.92,129.15,29.27,-109.13,181.34,0,0,0
-90.54,25.52,128.27,29.55,-108.77,181.36,0,0,0
-90.17,26.12,127.37,29.84,-108.4,181.39,0,0,0
-89.87,26.63,126.62,30.08,-108.09,181.41,0,0,0
-89.56,27.13,125.87,30.32,-107.78,181.43,0,0,0
-89.12,27.84,124.82,30.65,-107.35,181.46,0,0,0
-88.82,28.34,124.07,30.89,-107.04,181.48,0,0,0
-88.47,28.92,123.22,31.16,-106.69,181.5,0,0,0
-88.27,29.24,122.75,31.31,-106.5,181.52,0,0,0
-88.26,29.25,122.72,31.31,-106.49,181.52,0,1,0
-88.26,29.25,122.72,31.32,-106.49,181.52,0,1,0
-88.26,29.25,122.72,31.32,-106.49,181.52,0,1,0
-88.26,29.25,122.72,31.32,-106.49,181.52,0,1,0
-88.26,29.25,122.72,31.32,-106.49,181.52,0,1,0
-88.26,29.25,122.72,31.32,-106.49,181.52,0,1,0
-88.26,29.25,122.73,31.32,-106.49,181.52,0,1,0
-88.26,29.17,122.65,31.47,-106.49,181.52,0,1,0
-88.26,28.79,122.35,32.14,-106.49,181.52,0,1,0
-88.26,27.97,121.73,33.6,-106.49,181.51,0,1,0
-88.26,26.63,120.71,35.95,-106.49,181.51,0,1,0
-88.26,24.97,119.44,38.89,-106.5,181.51,0,1,0
-88.26,24.03,118.72,40.55,-106.5,181.5,0,1,0
-88.26,22.37,117.44,43.49,-106.5,181.5,0,1,0
-88.26,21.19,116.54,45.57,-106.51,181.5,0,1,0
-88.26,19.55,115.27,48.48,-106.51,181.49,0,1,0
-88.26,18.37,114.37,50.57,-106.51,181.49,0,1,0
-88.26,17.19,113.46,52.65,-106.52,181.49,0,1,0
-88.26,15.77,112.37,55.16,-106.52,181.48,0,1,0
-88.26,14.35,111.28,57.67,-106.52,181.48,0,1,0
-88.26,12.94,110.2,60.16,-106.53,181.47,0,1,0
-88.26,11.77,109.3,62.24,-106.53,181.47,0,1,0
-88.26,10.35,108.21,64.75,-106.54,181.47,0,1,0
-88.26,9.17,107.3,66.84,-106.54,181.46,0,1,0
-88.26,7.99,106.4,68.92,-106.54,181.46,0,1,0
-88.26,6.81,105.49,71,-106.54,181.46,0,1,0
-88.26,5.39,104.4,73.52,-106.55,181.46,0,1,0
-88.26,3.78,103.16,76.37,-106.55,181.45,0,1,0
-88.26,2.88,102.47,77.95,-106.55,181.45,0,1,0
-88.26,2.37,102.08,78.86,-106.56,181.45,0,1,0
-88.26,2.29,102.02,79.01,-106.56,181.45,0,1,0
-88.26,2.29,102.02,79.01,-106.56,181.45,0,1,0
""".strip()

def parse_lines_to_array(text: str):
    rows = []
    for ln in text.splitlines():
        ln = ln.strip()
        if not ln:
            continue
        parts = [p.strip() for p in ln.split(",")]
        if len(parts) < 9:
            raise ValueError(f"Line has <9 columns: {ln}")
        rows.append([float(x) for x in parts[:9]])
    return rows


def send_traj(rows):
    try:
        payload = {
            "type": "traj",
            "unit": "deg",
            "data": rows,
        }
        msg = json.dumps(payload)
        start = time.time()
        with socket.create_connection((HOST, PORT), timeout=3) as s:
            s.sendall(msg.encode("utf-8"))
            resp = s.recv(1024).decode("utf-8", errors="ignore")
            print("Server:", resp.strip())
        end = time.time()
        print(f"Time taken: {end - start:.3f} seconds")
    except Exception as e:
        print("Error sending trajectory:", e)


if __name__ == "__main__":
    rows = parse_lines_to_array(TEST_LINES)
    print(f"Prepared rows: {len(rows)}")
    print("Press '1' to send trajectory. Press 'q' or ESC to quit.")

    sent = False

    while True:
        key = keyboard.read_key(suppress=False)

        if key == "1" and not sent:
            print("[Action] Sending trajectory...")
            send_traj(rows)
            print("[Done] Trajectory sent.")
            sent = True
            print("Press '1' again to re-send, or 'q'/ESC to quit.")
            # 允許重送：把 sent=False 改掉即可
        elif key == "1" and sent:
            # 若你希望每次按 1 都能重送，註解掉 sent 機制即可
            print("[Info] Already sent once. (Remove 'sent' flag to allow re-send.)")
        elif key.lower() == "q" or key == "esc":
            print("Exit.")
            break
